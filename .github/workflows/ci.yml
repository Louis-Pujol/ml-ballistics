name: Python package

on:
  push:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    permissions:
        # Give the default GITHUB_TOKEN write permission to commit and push the changed files back to the repository.
        contents: write

    strategy:
      matrix:
        # os: [ubuntu-latest, macos-latest]
        python-version: ["3.11"]
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v4
        with:
            ref: ${{ github.head_ref }}
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install package (with dev dependencies)
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: Test with pytest and generate badges (coverage/tests)
        run: |
            pytest \
                --junitxml=reports/junit/junit.xml \
                --html=reports/junit/report.html \
                --cov=mlballistics \
                tests/
        
            coverage report
            coverage xml
            coverage html
        
            mkdir reports/coverage
            mv coverage.xml reports/coverage/coverage.xml
            mv htmlcov reports/coverage/htmlcov

            pip install genbadge[all]
            genbadge coverage
            genbadge tests
            
            if [ ! -d "badges" ]; then
                mkdir badges
            fi
            mv coverage-badge.svg badges/
            echo "coverage-badge.svg moved to badges folder"
            mv tests-badge.svg badges/
            echo "tests-badge.svg moved to badges folder"
            
            rm -r reports/
        
      - name: push badges to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
            commit_message: "[skip ci] add badges"

